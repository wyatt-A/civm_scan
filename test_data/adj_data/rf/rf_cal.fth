decimal
\ only forth also library definitions
\ lib-init
3      createlabels
\ PLATFORM: EVO
\ IMAGE SEQUENCE FILE:D:\dev\rfadjustments\civm_grad.seq
\ MR3031_PF1 FILE:D:\dev\rfadjustments\civm_rf.seq
VARIABLE NO_ECHOES
VARIABLE CURRENT_ECHO
VARIABLE NO_SLICES
VARIABLE CURRENT_SLICE
VARIABLE SLICE_INTERLEAVE
VARIABLE BATCH_SLICES 0 BATCH_SLICES !
VARIABLE BATCH_INTERLEAVE 1 BATCH_INTERLEAVE !
VARIABLE NO_AVERAGES
VARIABLE IMAGE_AV
2VARIABLE NO_VIEWS
2VARIABLE CURRENT_VIEW
2VARIABLE ECHO_CNT
2VARIABLE NO_VIEWS_2
VARIABLE SAMPLE_PERIOD
VARIABLE NO_SAMPLES
VARIABLE NO_DISCARD
VARIABLE VIEW_BLOCK
VARIABLE VIEW_AV
VARIABLE VIEWS_PER_SEG
VARIABLE SLICE_BLOCK
VARIABLE SLICE_AV
VARIABLE PHASE_CYCLE
VARIABLE NO_ACQ
\ COMMON OBS_MOD_LEVEL 0 f
VARIABLE REC_SEL
VARIABLE TEMP_MAC
2VARIABLE TEMP_MAC_LONG
VARIABLE GROUP_DELAY
VARIABLE TRMIN
VARIABLE CLOCK
VARIABLE TFILTER 373 TFILTER !
VARIABLE TREF
VARIABLE TIME
VARIABLE TR_EXTEND
VARIABLE TE_MS
VARIABLE TE_US
VARIABLE TE_MS_2
VARIABLE TE_US_2
VARIABLE RET
\ COMMON TR 2 f
\ COMMON TE 4 f
\ COMMON TE_EFF 6 f
\ COMMON REPORT_ON 8 f
2VARIABLE TACQ
2VARIABLE TEMPL1
2VARIABLE TEMPL2
2VARIABLE TEMPL3
2VARIABLE TEMPL4
2VARIABLE TEMPL5
2VARIABLE TR_MIN
\ COMMON T_GS_COMP a f
\ COMMON TCRUSH c f
VARIABLE ASYMM
VARIABLE RF_SP_ANGLE
VARIABLE DEG_90
VARIABLE DEG_117
VARIABLE RFSP_ON
2VARIABLE RF_INC
2VARIABLE RF_SP_TEMP
VARIABLE DEG_360
VARIABLE OVERHEAD
2VARIABLE PHASE_ANG
VARIABLE REMAINDER_PHASE
VARIABLE PHASE_CORRECTION
VARIABLE PHASE_CORRECTION_0
VARIABLE PHASE_CORRECTION_1
VARIABLE PHASE_CORRECTION_2
\ COMMON RF_ON e f
\ COMMON SUBJ_ANGLE_X 10 f
\ COMMON SUBJ_ANGLE_Y 12 f
\ COMMON SUBJ_ANGLE_Z 14 f
\ COMMON RFCAL 16 f
\ COMMON MHZ 18 f
\ COMMON KHZ 1a f
\ COMMON HZ 1c f
\ COMMON RX1MHZ 1e f
\ COMMON REC_FREQ 20 f
VARIABLE PULSE_BWDTH
VARIABLE SLICE_OFFSET
VARIABLE SLICE_OFF_FREQ
VARIABLE KHZ_NEW
VARIABLE HZ_NEW
VARIABLE KHZ_NEW2
VARIABLE HZ_NEW2
VARIABLE KHZ_NEW3
VARIABLE HZ_NEW3
2VARIABLE SLICE_FREQ_LONG
2VARIABLE READ_FREQ_LONG
\ COMMON GATING 22 f
\ COMMON CARDIAC_DEL 24 f
VARIABLE FLOW_COMP_ON
VARIABLE PE_FLOW
VARIABLE PE_FLOW_SEC
VARIABLE GR_FLOW
VARIABLE GS_FLOW
VARIABLE FLOW_MAT
\ COMMON P_SAT_SCALE 26 f
\ COMMON SAT_TCRUSH 28 f
\ COMMON SAT_GR_AMP 2a f
VARIABLE RFNUM_SAT
VARIABLE TSEL_SAT
VARIABLE SAT_PULSE_BWDTH
VARIABLE FOV_SAT_SLICE_FREQ
VARIABLE SAT_CRUSH_AMP
VARIABLE SATGS_ON
VARIABLE SAT_LIST
VARIABLE SAT_CHANNEL
VARIABLE GS_SAT
VARIABLE SAT_MAT
VARIABLE SAT_MAT_2
VARIABLE SAT_ORIENT
VARIABLE SAT_FOV_SCALE
\ COMMON P_SAT_MUL 2c f
2VARIABLE SAT_SLICE_FREQ_LONG
VARIABLE PE_REPHASE_ON
VARIABLE GRAD_SPOIL_ON
VARIABLE GRAD_SPOIL_AMP
VARIABLE SLICE_REPHASE
\ COMMON GRAD_AMP 2e f
VARIABLE SLICE_LIST
VARIABLE READ_LIST
VARIABLE PHASE_LIST
VARIABLE SCALE_READ_OFF
VARIABLE SCALE_PHASE_OFF
VARIABLE SCALE_SLICE_OFF
VARIABLE FOV_READ_FREQ
VARIABLE FOV_PHASE_DEG
VARIABLE FOV_SLICE_FREQ
VARIABLE NEW_SLICE_OFFSET
VARIABLE GP_INC
VARIABLE GP_VAR
VARIABLE DACMAX 32767 DACMAX !
VARIABLE GP_INIT_VAR_RESCALE
VARIABLE GS_VAR_RESCALE
VARIABLE OVERSAMPLE
VARIABLE OVERSAMPLE2
VARIABLE GR_OVERSAMPLE
VARIABLE GR_UNDERSAMPLE
VARIABLE GP_OVERSAMPLE
VARIABLE GP_UNDERSAMPLE
4 2CREATE-ARRAY GRAD_VAR
4 CREATE-ARRAY GRAD_VAR_L
VARIABLE TRAMP
VARIABLE GP_INIT_VAR
VARIABLE GR_VAR
VARIABLE GR_VAR_S
VARIABLE GS_VAR
VARIABLE GR_COMP
VARIABLE GR_COMP_S
VARIABLE GS_COMP
VARIABLE GS_COMP_S
VARIABLE GR_CRUSH
VARIABLE GS_CRUSH
VARIABLE GP_CRUSH
2VARIABLE DACMAXLONG 0x7fff 0x0 DACMAXLONG 2!
\ COMMON GR_COMP_SCALE 30 f
\ COMMON GS_COMP_SCALE 32 f
\ COMMON GR_ON 34 f
\ COMMON GP_ON 36 f
\ COMMON GS_ON 38 f
VARIABLE PHASE_90
VARIABLE PHASE_180
VARIABLE PHASE_117
VARIABLE TSEL90
VARIABLE TSEL180
\ COMMON P90_MUL 3a f
\ COMMON P180_MUL 3c f
VARIABLE WARMUP 20 WARMUP !
VARIABLE PHASE_RES 225 PHASE_RES !
VARIABLE RFNUM
VARIABLE PHASE_REC
VARIABLE PHASE_REC_CAL1
VARIABLE PHASE_REC_CAL2
40 CREATE-ARRAY RF_LENGTH
40 CREATE-ARRAY RF_BWDTH
40 CREATE-ARRAY RAD
40 CREATE-ARRAY RWT
40 CREATE-ARRAY RBD
\ COMMON P180_SCALE 3e f
\ COMMON ALPHA 40 f
VARIABLE FOV_READ_OFF
VARIABLE FOV_PHASE_OFF
VARIABLE FOV_SLICE_OFF
\ COMMON PHASE_VAR 42 f
\ COMMON S_ANGLE_VAR 44 f
\ COMMON P_ANGLE_VAR 46 f
\ COMMON R_ANGLE_VAR 48 f

VARIABLE MD_TDEL
VARIABLE MD_CLOCK
VARIABLE MD_ADDR
: MR3040_DELAY
MD_ADDR !
MD_CLOCK !
MD_TDEL !
MD_CLOCK @
   
10 noop
 >
IF
MD_TDEL @
10 noop
MD_CLOCK @
 */
MD_TDEL !
THEN
MD_TDEL @
   
 [ 56832 ,code 4095 ,code ]
 >
IF
BEGIN
0 noop
MD_ADDR @
1 noop
 [ 56832 ,code 4095 ,code ]
MR3040_OUTPUT
MD_TDEL @
   
 [ 56832 ,code 4095 ,code ]
 -
MD_TDEL !
MD_TDEL @
   
 [ 56832 ,code 4095 ,code ]
 > NOT
 UNTIL
THEN
MD_TDEL @
   
0 noop
 >
IF
0 noop
MD_ADDR @
1 noop
MD_TDEL @
MR3040_OUTPUT
THEN
 ;
VARIABLE TEMP_3040

VARIABLE CMT_MAT
VARIABLE CMT_S
VARIABLE CMT_P
VARIABLE CMT_R
VARIABLE CMT_I
: CREATEMATRIXTEST
CMT_R !
CMT_P !
CMT_S !
CMT_MAT !
CMT_MAT @
DACMAX @
CMT_S @
DACMAX @
CMT_P @
DACMAX @
CMT_R @
[ 56832 ,code 66 ,code ] 15 far@
[ 56832 ,code 68 ,code ] 15 far@
[ 56832 ,code 70 ,code ] 15 far@
[ 56832 ,code 72 ,code ] 15 far@
MR3040_CREATEMATRIX
CMT_I !
CMT_I @
IF
." Failed to create matrix = "
CMT_MAT @
 .
." , return code = "
CMT_I @
 .
 CR
THEN
CMT_I @
EXIT
 ;
\ MR3031_PF1 FILE:c:\smis\seqlib\RFstd.seq
\ IMAGE SEQUENCE FILE:c:\smis\seqlib\g3040_15.seq
1 CONST-LIT C_CALC_MAT
2 CONST-LIT C_SLICE_SELECT_MAT
VARIABLE SLICE_SELECT_SLICE
VARIABLE C_SLICE_SELECT_MAT_READ
VARIABLE C_SLICE_SELECT_MAT_PHASE
VARIABLE C_SLICE_SELECT_MAT_SLICE
VARIABLE EXCITATION_POWER
VARIABLE EXCITATION_PHASE
VARIABLE ACQUIRE_PHASE
VARIABLE LUT_TEMPVAL_1
VARIABLE LUT_TEMPVAL_2
2VARIABLE TEMPVAL_LONG
2VARIABLE LUT_INDEX
\ COMMON PTS_MASK 4a f
2VARIABLE NO_COMPLETED_VIEWS
VARIABLE NO_COMPLETED_AVERAGES
2VARIABLE TEMPLONG1
2VARIABLE TEMPLONG2
VARIABLE OFFSETINPAGE
VARIABLE PAGE
VARIABLE IS16BIT
: MAIN STREAMON DECIMAL
1 noop
IS16BIT !
C_CALC_MAT
MR3040_SELECTMATRIX
0 noop
2* 2* GRAD_VAR +
q2@
   
4 noop
S>D
 D/
DROP
0 noop
2* GRAD_VAR_L +
!
1 noop
2* 2* GRAD_VAR +
q2@
   
4 noop
S>D
 D/
DROP
1 noop
2* GRAD_VAR_L +
!
2 noop
2* 2* GRAD_VAR +
q2@
   
4 noop
S>D
 D/
DROP
2 noop
2* GRAD_VAR_L +
!
3 noop
2* 2* GRAD_VAR +
q2@
   
4 noop
S>D
 D/
DROP
3 noop
2* GRAD_VAR_L +
!
 [ 56832 ,code -900 ,code ]
0 noop
0 noop
3 noop
2* GRAD_VAR_L +
@
0 noop
2* GRAD_VAR_L +
@
2 noop
2* GRAD_VAR_L +
@
0 noop
2* GRAD_VAR_L +
@
1 noop
2* GRAD_VAR_L +
@
0 noop
2* GRAD_VAR_L +
@
MR3040_CREATEBASEMATRIX
TEMP_MAC !
TEMP_MAC @
IF
." Could not create base matrix, status = "
TEMP_MAC @
 .
 CR
                                      XGOTO 0
THEN
[ 56832 ,code 99 ,code ] us
0 noop
MR3040_SETLISTADDRESS
MR3040_INITLIST
TEMP_3040 !
0 noop
 [ 56832 ,code 861 ,code ]
 [ 56832 ,code 50 ,code ]
1 noop
MR3040_OUTPUT
 [ 56832 ,code 255 ,code ]
0 noop
0 noop
0 noop
CREATEMATRIXTEST
IF
                                      XGOTO 0
THEN
[ 56832 ,code 99 ,code ] us
 [ 56832 ,code 511 ,code ]
0 noop
0 noop
0 noop
CREATEMATRIXTEST
IF
                                      XGOTO 0
THEN
[ 56832 ,code 99 ,code ] us
TEMP_3040 @
 [ 56832 ,code 546 ,code ]
MR3040_SETLIST
 [ 56832 ,code 255 ,code ]
MR3040_SELECTMATRIX
 [ 56832 ,code 546 ,code ]
MR3040_START
[ 56832 ,code 999 ,code ] us
20 noop
MR3040_CLOCK
NO_DISCARD @
DISCARD
0 noop
FREQUENCY_BUFFER
[ 56832 ,code 24 ,code ] 15 far@
[ 56832 ,code 26 ,code ] 15 far@
[ 56832 ,code 28 ,code ] 15 far@
[ 56832 ,code 30 ,code ] 15 far@
FREQUENCY
RESET_FREQUENCY
1 noop
PHASE_INCREMENT
MR3040_INITLIST
SLICE_SELECT_SLICE !
0 noop
1 noop
 [ 56832 ,code 2917 ,code ]
5 noop
MR3040_OUTPUT
0 noop
EXCITATION_PHASE !
0 noop
EXCITATION_POWER !
8 noop
1 noop
2* RAD +
!
 [ 56832 ,code 100 ,code ]
1 noop
2* RWT +
!
 [ 56832 ,code -240 ,code ]
1 noop
2* RBD +
!
 [ 56832 ,code 100 ,code ]
1 noop
2* RF_LENGTH +
!
 [ 56832 ,code 50 ,code ]
1 noop
2* RF_BWDTH +
!
0 noop
ACQUIRE_PHASE !
SYNC
STARTTIMER
0 noop
S>D
NO_COMPLETED_VIEWS 2!
LABEL 1
0 noop
NO_COMPLETED_AVERAGES !
LABEL 2
 [ 56832 ,code 500 ,code ]
WAITTIMER
STARTTIMER
HOSTREQUEST
drop
[ 56832 ,code 74 ,code ] 15 far@
SYSTEMOUT
0 noop
C_SLICE_SELECT_MAT_READ !
0 noop
C_SLICE_SELECT_MAT_PHASE !
 [ 56832 ,code 427 ,code ]
C_SLICE_SELECT_MAT_SLICE !
C_SLICE_SELECT_MAT
C_SLICE_SELECT_MAT_SLICE @
C_SLICE_SELECT_MAT_PHASE @
C_SLICE_SELECT_MAT_READ @
CREATEMATRIXTEST
IF
                                      XGOTO 0
THEN
[ 56832 ,code 99 ,code ] us
0 noop
EXCITATION_PHASE !
NO_COMPLETED_VIEWS q2@
   
 [ 56832 ,code 50 ,code ]
S>D
 D*
   
0 noop
S>D
 D+
DROP
EXCITATION_POWER !
0 noop
ACQUIRE_PHASE !
 [ 56832 ,code 30000 ,code ]
WAITTIMER
STARTTIMER
C_SLICE_SELECT_MAT
MR3040_SELECTMATRIX
SLICE_SELECT_SLICE @
 [ 56832 ,code 512 ,code ]
MR3040_SETLIST
 [ 56832 ,code 300 ,code ]
WAITTIMER
STARTTIMER
 [ 56832 ,code 512 ,code ]
MR3040_START
 [ 56832 ,code 300 ,code ]
WAITTIMER
 [ 56832 ,code 9298 ,code 56832 ,code 0 ,code  ]
DELAY32
STARTTIMER
RESYNC
EXCITATION_PHASE @
PHASE
 [ 56832 ,code 400 ,code ]
WAITTIMER
 [ 56832 ,code 60 ,code ]
   
22 noop
   
WARMUP @
 +
 -
TEMP_MAC !
TEMP_MAC @
 2- us 0.7us
EXCITATION_POWER @
0 noop
1 noop
2* RBD +
@
SET_BOARD_MULTIPLIERS
1 noop
2* RAD +
@
1 noop
2* RBD +
@
   
4 noop
 +
SET3031ADDRESS
1 noop
2* RWT +
@
1 noop
2* RBD +
@
   
4 noop
 +
SET3031WAITS
1 noop
2* RBD +
@
   
4 noop
 +
APPEND_BOARDS_READY
0 noop
RFAMPON
WARMUP @
 2- us 0.7us
4 noop
RFON
MR3031_GO
 [ 56832 ,code 97 ,code ]
TEMP_MAC !
TEMP_MAC @
 2- us 0.7us
0 noop
RFON
 [ 56832 ,code -2622 ,code 56832 ,code 0 ,code  ]
DELAY32
STARTTIMER
RESYNC
EXCITATION_PHASE @
PHASE
 [ 56832 ,code 400 ,code ]
WAITTIMER
 [ 56832 ,code 60 ,code ]
   
22 noop
   
WARMUP @
 +
 -
TEMP_MAC !
TEMP_MAC @
 2- us 0.7us
EXCITATION_POWER @
0 noop
1 noop
2* RBD +
@
SET_BOARD_MULTIPLIERS
1 noop
2* RAD +
@
1 noop
2* RBD +
@
   
4 noop
 +
SET3031ADDRESS
1 noop
2* RWT +
@
1 noop
2* RBD +
@
   
4 noop
 +
SET3031WAITS
1 noop
2* RBD +
@
   
4 noop
 +
APPEND_BOARDS_READY
0 noop
RFAMPON
WARMUP @
 2- us 0.7us
4 noop
RFON
MR3031_GO
 [ 56832 ,code 97 ,code ]
TEMP_MAC !
TEMP_MAC @
 2- us 0.7us
0 noop
RFON
 [ 56832 ,code -21543 ,code 56832 ,code 0 ,code  ]
DELAY32
STARTTIMER
RESYNC
ACQUIRE_PHASE @
RPHASE
 [ 56832 ,code 500 ,code ]
WAITTIMER
SAMPLE_PERIOD @
NO_SAMPLES @
ACQUIRE
 [ 56832 ,code -25320 ,code 56832 ,code 0 ,code  ]
DELAY32
STARTTIMER
RESYNC
EXCITATION_PHASE @
PHASE
 [ 56832 ,code 400 ,code ]
WAITTIMER
 [ 56832 ,code 60 ,code ]
   
22 noop
   
WARMUP @
 +
 -
TEMP_MAC !
TEMP_MAC @
 2- us 0.7us
EXCITATION_POWER @
0 noop
1 noop
2* RBD +
@
SET_BOARD_MULTIPLIERS
1 noop
2* RAD +
@
1 noop
2* RBD +
@
   
4 noop
 +
SET3031ADDRESS
1 noop
2* RWT +
@
1 noop
2* RBD +
@
   
4 noop
 +
SET3031WAITS
1 noop
2* RBD +
@
   
4 noop
 +
APPEND_BOARDS_READY
0 noop
RFAMPON
WARMUP @
 2- us 0.7us
4 noop
RFON
MR3031_GO
 [ 56832 ,code 97 ,code ]
TEMP_MAC !
TEMP_MAC @
 2- us 0.7us
0 noop
RFON
 [ 56832 ,code -21543 ,code 56832 ,code 0 ,code  ]
DELAY32
STARTTIMER
RESYNC
ACQUIRE_PHASE @
RPHASE
 [ 56832 ,code 500 ,code ]
WAITTIMER
SAMPLE_PERIOD @
NO_SAMPLES @
ACQUIRE
 [ 56832 ,code 16064 ,code 56832 ,code 7 ,code  ]
DELAY32
STARTTIMER
NO_COMPLETED_AVERAGES @
   
1 noop
 +
NO_COMPLETED_AVERAGES !
NO_COMPLETED_AVERAGES @
   
1 noop
   
NO_AVERAGES @
 [ 45207 ,code 48662 ,code ] swapdrop
 <
IF
XGOTO 2
THEN
NO_COMPLETED_VIEWS q2@
   
1 noop
S>D
 D+
NO_COMPLETED_VIEWS 2!
NO_COMPLETED_VIEWS q2@
   
1 noop
S>D
NO_VIEWS q2@
 D*
 D<
IF
XGOTO 1
THEN
LABEL 0
 ;
